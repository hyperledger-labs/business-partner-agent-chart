# Business Partner Agent Chart

The Business Partner Agent allows to manage and exchange master data between organizations.

This chart will install a business partner agent (bpa-core & bpa-acapy) and Postgres.

It will also create the default ingress routes.

## TL;DR

```sh
helm repo add bpa https://labs.hyperledger.org/business-partner-agent-chart/
helm repo update
helm upgrade \
	--set global.ingressSuffix=.example.com \
   	mybpa bpa/bpa -i -n mynamespace --devel
```

## Introduction

This chart bootstraps a business partner agent deployment on a Kubernetes cluster using the Helm package manager.
Its default installation comes with PostgreSQL.
Ingress routes are generated and activated, allowing the agent to communicate with other agents outside the cluster.

## Requirements

- Kubernetes 1.12+
- Docker
- Helm v3.3.4+
- PV provisioner support in the underlying infrastructure (for PostgreSQL persistence)
- If activating Ingress (with is the default!):
  - Ingress controller installed
  - Cert-manager (TLS required/assumed for both endpoint: public profile and acapy)
  - DNS records pointing to your routes

## Initial preparation

The following steps have to be done only once.

## Installing the chart

To install the chart with the release name `bpa` and generated ingress as subdomains of `example.com` in the namespace `mynamespace`

```sh
helm repo add bpa https://labs.hyperledger.org/business-partner-agent-chart/
helm repo update
helm upgrade \
	--set global.ingressSuffix=.example.com \
   	mybpa bpa/bpa -i -n mynamespace --devel
```

Get the generated application URL by running `kubectl`
```sh
kubectl get ingress -n mynamespace
```

Like this we deployed the BPA (bpa-core & bpa-acapy) and Postgres on the Kubernetes cluster in the default configuration. The [Values](#Values) section list the parameters that can be configured during installation.

#### Install chart with values file

Alternatively, a YAML file that specifies the values for the parameters can be provided while installing the chart.
E.g. deploying the chart to the IDunion network could be done as follows.

Remark:
In IDunion the DID cannot be autogenerated, therefore a seed has to be configured as pre-requisite.
To do so, create a secret in the same namespace named `<helm release>-acapy` and a key called `seed`.

Create a yaml file.
```yaml
cat <<EOT >> values-mybpa.yaml
global:
  ingressSuffix: .example.com
bpa:
    config:
      name: My BPA
      bootstrap:
        username: alice
        password: changeme
      ledger:
        browser: https://explorer.idu.network
      did:
        prefix: "did:sov:idu:"
      schemas:
        bank-account:
          id: "UmZ25DANwS6ngGWB4ye4tN:2:BankAccount:0.1"
          label: "Bank Account"
          defaultAttributeName: "iban"
          restrictions:
            - issuerDid: "did:sov:idu:UmZ25DANwS6ngGWB4ye4tN"
              label: "Demo Bank"
        commercial-register:
          id: "R6WR6n7CQVDjvvmwofHK6S:2:commercialregister:0.1"
          label: "Commercial Register"
          defaultAttributeName: "companyName"
          restrictions:
            - issuerDid: "did:sov:idu:R6WR6n7CQVDjvvmwofHK6S"
              label: "Commercial Register"
acapy:
  agentName: mybpa

postgresql:
  persistence:
    enabled: true
    storageClass: default
    size: 1Gi
EOT
```

Install the chart with the release name `mybpa`, in the namespace `mynamespace`.

```sh
helm upgrade \
	--values values-mybpa.yaml \
   	mybpa bpa/bpa -i -n mynamespace --devel
```
#### Install multiple bpa instances

> You could easily deploy a second business partner agent like this, e.g. for demo purpose.
> Just use a different helm release name, the seed of another DID and different ingress host names.

#### Install in local development cluster

No special handling, should work the same way as with a remote cluster.
With minikube you would

Install and run minikube (see also minikube [documentation](https://minikube.sigs.k8s.io/docs/start/))
```sh
 curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
 sudo install minikube-linux-amd64 /usr/local/bin/minikube
 minikube start --vm-driver=docker

```

Install the chart
```sh
helm upgrade \
	--values values-mybpa.yaml \
   	mybpa bpa/bpa -i -n mynamespace --devel
```

## Uninstalling the Chart

To uninstall/delete the my-release deployment:

```sh
helm delete mybpa
```

The command removes all the Kubernetes components but PVC's associated with the chart and deletes the release.

To delete the PVC's associated with my-release:

```sh
kubectl delete pvc -l release=mybpa
```

Note: Deleting the PVC's will delete postgresql data as well. Please be cautious before doing it.

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| acapy.adminURLApiKey | string | `"2f9729eef0be49608c1cffd49ee3cc4a"` |  |
| acapy.affinity | object | `{}` |  |
| acapy.agentName | string | `"ca-aca-py"` |  |
| acapy.fullnameOverride | string | `""` |  |
| acapy.image.pullPolicy | string | `"IfNotPresent"` |  |
| acapy.image.repository | string | `"bcgovimages/aries-cloudagent"` |  |
| acapy.image.tag | string | `"py36-1.16-0_0.6.0"` | Overrides the image tag whose default is the chart appVersion. |
| acapy.imagePullSecrets | list | `[]` |  |
| acapy.ingress.annotations | object | `{}` |  |
| acapy.ingress.enabled | bool | `true` |  |
| acapy.ingress.tls | list | `[]` |  |
| acapy.name | string | `"acapy"` |  |
| acapy.nameOverride | string | `""` |  |
| acapy.nodeSelector | object | `{}` |  |
| acapy.openshift.route.enabled | bool | `false` | Set to true and acapy.ingress.enabled to false to use Openshift route templates |
| acapy.openshift.route | object | `{"enabled": false, "path": "/", "targetPort": "http", "timeout": "30s", "tls": { "enabled": true, "insecureEdgeTerminationPolicy": "None", "termination": "edge" }, "wildcardPolicy": "None" }` | Configuration for the route, https/tls is optional |
| acapy.podAnnotations | object | `{}` |  |
| acapy.podSecurityContext | object | `{}` |  |
| acapy.readOnlyMode | bool | `false` |  |
| acapy.resources | object | `{}` |  |
| acapy.securityContext.runAsUser | int | `1001` |  |
| acapy.service.adminPort | int | `8031` |  |
| acapy.service.httpPort | int | `8030` |  |
| acapy.service.type | string | `"ClusterIP"` |  |
| acapy.staticArgs | object | `{"autoAcceptInvites": true, "autoAcceptRequests": true, "autoRespondMessages": true, "autoRespondCredentialProposal": true, "autoRespondCredentialOffer": true, "autoRespondCredentialRequest": true, "autoRespondPresentationProposal": true, "autoRespondPresentationRequest": true, "autoStoreCredential": true, "autoVerifyPresentation": true, "autoPingConnection": true, "autoProvision": true, "monitorPing": true, "publicInvites": true, "logLevel": "info" }` | Set all the arguments for the acapy agent   |
| acapy.tolerations | list | `[]` |  |
| bpa.affinity | object | `{}` |  |
| bpa.config | object | `{"bootstrap":{"password":"changeme","username":"admin"},"creddef":{"revocationRegistrySize":3000},"ledger":{"browser":"https://indy-test.bosch-digital.de"},"name":"Business Partner Agent","resolver":{"url":"https://resolver.stage.economyofthings.io"},"security":{"enabled":true},"web":{"only":false}}` | application config (remark: all new configuration values will sit here, the other ones can be migrated step by step) |
| bpa.image.pullPolicy | string | `"IfNotPresent"` |  |
| bpa.image.repository | string | `"ghcr.io/hyperledger-labs/business-partner-agent"` |  |
| bpa.image.tag | string | `""` | Overrides the image tag whose default is the chart appVersion. |
| bpa.imagePullSecrets | list | `[]` |  |
| bpa.ingress.annotations | object | `{}` |  |
| bpa.ingress.enabled | bool | `true` |  |
| bpa.ingress.tls | list | `[]` |  |
| bpa.name | string | `"bpacore"` |  |
| bpa.nodeSelector | object | `{}` |  |
| bpa.openshift.route.enabled | bool | `false` | Set to true and bpa.ingress.enabled to false to use Openshift route templates |
| bpa.openshift.route | object | `{"enabled": false, "path": "/", "targetPort": "http", "timeout": "30s", "tls": { "enabled": true, "insecureEdgeTerminationPolicy": "None", "termination": "edge" }, "wildcardPolicy": "None" }` | Configuration for the route, https/tls is optional |
| bpa.podAnnotations | object | `{}` |  |
| bpa.podSecurityContext | object | `{}` |  |
| bpa.resources | object | `{}` |  |
| bpa.securityContext | object | `{}` |  |
| bpa.service.port | int | `80` |  |
| bpa.service.type | string | `"ClusterIP"` |  |
| bpa.serviceAccount.annotations | object | `{}` |  |
| bpa.serviceAccount.create | bool | `true` |  |
| bpa.serviceAccount.name | string | `""` |  |
| bpa.tolerations | list | `[]` |  |
| global.fullnameOverride | string | `""` |  |
| global.ingressSuffix | string | `".example.com"` |  |
| global.nameOverride | string | `""` |  |
| global.persistence.deployPostgres | bool | `true` | If true, the Postgres chart is deployed |
| keycloak.enabled | bool | `false` | If true, adds security-keycloak.yml to micronaut config files |
| keycloak.clientId | string |  | name of client in keycloak realm |
| keycloak.clientSecret | string |  | value of client secret in keycloak realm |
| keycloak.config | object | `{"rolesName": "roles", "nameKey": "preferred_username", "redirectUri": "${bpa.scheme}://${bpa.host}/logout", "scopes": "openid", "issuer": "<your keycloak realm issuer url>", "endsessionUrl": "<your keycloak realm end session url>" }` | configuration data, stored in ConfigMap, read by security-keycloak.yml |
| postgresql.image.tag | int | `12` |  |
| postgresql.persistence | object | `{"enabled":false}` | Persistent Volume Storage configuration. ref: https://kubernetes.io/docs/user-guide/persistent-volumes |
| postgresql.persistence.enabled | bool | `false` | Enable PostgreSQL persistence using Persistent Volume Claims. |
| postgresql.postgresqlDatabase | string | `"bpa"` | PostgreSQL Database to create. |
| postgresql.postgresqlPassword | string | `"change-me"` | PostgreSQL Password for the new user. If not set, a random 10 characters password will be used. |
| postgresql.postgresqlUsername | string | `"postgres"` | PostgreSQL User to create. Do not change - otherwise non-admin user is created! |
| postgresql.service | object | `{"port":5432}` | PostgreSQL service configuration |
| schemas.enabled | bool | `false` | If true, adds schemas.yml to micronaut config files |
| schemas.config | object | `{"bank-account": { "id": "UmZ25DANwS6ngGWB4ye4tN:2:BankAccount:0.1", "label": "Bank Account", "defaultAttributeName": "iban", "restrictions": [{"issuerDid": "did:sov:iil:UmZ25DANwS6ngGWB4ye4tN","label": "Demo Bank"}]},"commercial-register": {"id": "R6WR6n7CQVDjvvmwofHK6S:2:commercialregister:0.1", "label": "Commercial Register", "defaultAttributeName": "companyName", "restrictions": [{ "issuerDid": "did:sov:iil:R6WR6n7CQVDjvvmwofHK6S", "label": "Commercial Register" }]}}` | configuration data for schemas to load, stored in ConfigMap as schemas.yml, mounted into bpa deployment |

## Chart dependencies
| Repository | Name | Version |
|------------|------|---------|
| https://charts.bitnami.com/bitnami/ | postgresql | 10.3.13 |

## Maintainers

| Name | Email | Url |
| ---- | ------ | --- |
| Frank Bernhardt | Frank.Bernhardt@bosch.com |  |
| Jason Syrotuck | jason.syrotuck@nttdata.com |  |
